<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WhatsApp Clone Â· No CORS Â· No Prompt</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ---------- FULL WHATSAPP INSPIRED UI ---------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #e5ded8; height: 100vh; display: flex; justify-content: center; align-items: center;
    }
    #app {
      width: 100%; max-width: 1400px; height: 100vh; max-height: 800px;
      background: white; box-shadow: 0 6px 18px rgba(0,0,0,0.1); border-radius: 24px; overflow: hidden; position: relative;
    }
    /* ----- AUTH VIEW ----- */
    #auth-container {
      height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: linear-gradient(145deg, #075E54 0%, #128C7E 100%); padding: 20px;
    }
    .auth-card {
      background: white; width: 100%; max-width: 440px; border-radius: 28px; padding: 32px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .auth-tabs { display: flex; margin-bottom: 24px; border-bottom: 2px solid #f0f0f0; }
    .auth-tab { flex: 1; text-align: center; padding: 12px; font-weight: 600; color: #888; cursor: pointer; transition: 0.2s; }
    .auth-tab.active { color: #075E54; border-bottom: 3px solid #075E54; }
    .auth-form { display: none; flex-direction: column; }
    .auth-form.active { display: flex; }
    .auth-form h2 { margin-bottom: 24px; color: #075E54; font-size: 1.6rem; }
    .input-group { margin-bottom: 16px; position: relative; }
    .input-group i { position: absolute; left: 14px; top: 14px; color: #999; }
    .input-group input {
      width: 100%; padding: 14px 14px 14px 44px; border: 1px solid #ddd; border-radius: 30px;
      font-size: 15px; transition: 0.2s;
    }
    .input-group input:focus { border-color: #075E54; outline: none; box-shadow: 0 0 0 3px rgba(7,94,84,0.1); }
    .btn {
      background: #075E54; color: white; border: none; padding: 14px; border-radius: 30px;
      font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: 8px;
    }
    .btn:hover { background: #0b7a6b; }
    .error-message { color: #d32f2f; font-size: 14px; margin-top: 12px; text-align: center; }

    /* ----- CHAT VIEW (WhatsApp) ----- */
    #chat-container { display: none; height: 100%; width: 100%; background: #efeae2; flex-direction: row; }
    .chat-sidebar { width: 35%; max-width: 400px; background: white; border-right: 1px solid #e9edef; display: flex; flex-direction: column; }
    .sidebar-header { background: #f0f2f5; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e9edef; }
    .user-profile { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 42px; height: 42px; border-radius: 50%; background: #075E54; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; text-transform: uppercase; }
    .user-name { font-weight: 600; color: #111; }
    .new-chat-btn { background: none; border: none; font-size: 22px; color: #54656f; cursor: pointer; padding: 8px; border-radius: 50%; }
    .new-chat-btn:hover { background: #e9edef; }
    .search-box { padding: 12px 16px; background: white; }
    .search-box input { width: 100%; padding: 12px 16px; border: none; background: #f0f2f5; border-radius: 30px; font-size: 15px; }
    .conversations-list { flex: 1; overflow-y: auto; background: white; }
    .conversation-item { display: flex; align-items: center; padding: 12px 20px; gap: 12px; cursor: pointer; border-bottom: 1px solid #f0f2f5; transition: 0.1s; }
    .conversation-item:hover, .conversation-item.active { background: #f0f2f5; }
    .conv-avatar { width: 50px; height: 50px; border-radius: 50%; background: #128C7E; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 20px; }
    .conv-details { flex: 1; overflow: hidden; }
    .conv-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .conv-name { font-weight: 600; color: #111; }
    .conv-time { font-size: 12px; color: #667781; }
    .conv-last-msg { color: #667781; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-main { flex: 1; display: flex; flex-direction: column; background: #efeae2; }
    .chat-header { background: #f0f2f5; padding: 16px 24px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #e9edef; }
    .chat-header .avatar { width: 42px; height: 42px; }
    .contact-info { flex: 1; }
    .contact-name { font-weight: 600; font-size: 18px; }
    .messages-area {
      flex: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column;
      background-image: url('https://web.whatsapp.com/img/bg-chat-tile-dark_a4be512e7195b6b733d9110b408cd075.png');
      background-repeat: repeat; background-size: contain;
    }
    .message-bubble { max-width: 65%; padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; word-wrap: break-word; position: relative; font-size: 15px; }
    .message-sent { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; }
    .message-received { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }
    .message-time { font-size: 11px; color: #667781; margin-top: 4px; text-align: right; }
    .chat-input-area { background: #f0f2f5; padding: 16px 24px; display: flex; gap: 16px; align-items: center; }
    .chat-input-area input { flex: 1; padding: 14px 18px; border: none; border-radius: 30px; background: white; font-size: 16px; }
    .chat-input-area button { background: #075E54; color: white; border: none; width: 48px; height: 48px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 24px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { color: #075E54; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
    .user-list-item { display: flex; align-items: center; padding: 12px; border-radius: 12px; cursor: pointer; }
    .user-list-item:hover { background: #f0f2f5; }
    .no-conversations { padding: 32px; text-align: center; color: #667781; }
  </style>
</head>
<body>
<div id="app">
  <!-- AUTH VIEW -->
  <div id="auth-container">
    <div class="auth-card">
      <div class="auth-tabs">
        <div id="login-tab" class="auth-tab active">Login</div>
        <div id="register-tab" class="auth-tab">Register</div>
      </div>
      <!-- Login Form -->
      <div id="login-form" class="auth-form active">
        <h2>Sign in</h2>
        <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="login-email" placeholder="Email" autocomplete="email"></div>
        <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="login-password" placeholder="Password"></div>
        <button class="btn" onclick="handleLogin()">Login</button>
        <div id="login-error" class="error-message"></div>
      </div>
      <!-- Register Form -->
      <div id="register-form" class="auth-form">
        <h2>Create account</h2>
        <div class="input-group"><i class="fas fa-user"></i><input type="text" id="reg-name" placeholder="Full name"></div>
        <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="reg-email" placeholder="Email"></div>
        <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="reg-password" placeholder="Password"></div>
        <button class="btn" onclick="handleRegister()">Register</button>
        <div id="register-error" class="error-message"></div>
      </div>
    </div>
  </div>

  <!-- CHAT VIEW -->
  <div id="chat-container">
    <div class="chat-sidebar">
      <div class="sidebar-header">
        <div class="user-profile"><div class="avatar" id="user-avatar"></div><span class="user-name" id="sidebar-user-name">Loading...</span></div>
        <button class="new-chat-btn" onclick="openNewChatModal()"><i class="fas fa-comment"></i></button>
      </div>
      <div class="search-box"><input type="text" id="search-chat" placeholder="Search or start new chat" onkeyup="filterConversations()"></div>
      <div class="conversations-list" id="conversations-list"><div class="no-conversations">No chats yet. Start a new one!</div></div>
    </div>
    <div class="chat-main">
      <div class="chat-header" id="chat-header" style="display: none;">
        <div class="avatar" id="chat-avatar">?</div>
        <div class="contact-info"><div class="contact-name" id="chat-contact-name">Select a chat</div></div>
      </div>
      <div class="messages-area" id="messages-area"></div>
      <div class="chat-input-area" id="chat-input-area" style="display: none;">
        <input type="text" id="message-input" placeholder="Type a message" autocomplete="off">
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div id="newChatModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>New Chat</h3><button class="close-btn" onclick="closeNewChatModal()">&times;</button></div>
      <input type="text" id="search-users" placeholder="Search users..." style="width:100%; padding:12px; border-radius:30px; border:1px solid #ddd; margin-bottom:20px;" onkeyup="filterUsers()">
      <div id="users-list" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
  </div>
</div>

<script>
  // ========== ðŸ”¥ YOUR APPS SCRIPT URL â€“ HARDCODED (EDIT IF NEEDED) ==========
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzr6hhvMy7X6_zCzksBysFuKKqPEwn9qAcen-0zDmuJdF_TYTwrmT0F6ITynEerMoAI/exec';
  // ==========================================================================

  let currentUser = null;
  let selectedContact = null;
  let allUsers = [];
  let conversations = [];
  let messagesPollInterval = null;

  // ---------- API CALL â€“ NO CORS PREFLIGHT (text/plain) ----------
  async function apiRequest(action, payload) {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action, ...payload }),
        headers: { 'Content-Type': 'text/plain' }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (err) {
      console.error(err);
      return { success: false, message: 'Network error â€“ check URL or deployment' };
    }
  }

  // ---------- UTILS ----------
  function formatTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  function showError(formId, msg) {
    document.getElementById(formId).innerText = msg;
  }

  // ---------- AUTH ----------
  async function handleRegister() {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value.trim();
    if (!name || !email || !password) return showError('register-error', 'All fields required');
    const res = await apiRequest('register', { name, email, password });
    if (res.success) {
      showError('register-error', 'Registration successful! Please login.');
      document.getElementById('reg-name').value = '';
      document.getElementById('reg-email').value = '';
      document.getElementById('reg-password').value = '';
      document.getElementById('login-tab').click();
    } else {
      showError('register-error', res.message);
    }
  }

  async function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    if (!email || !password) return showError('login-error', 'Enter credentials');
    const res = await apiRequest('login', { email, password });
    if (res.success) {
      currentUser = res.user;
      localStorage.setItem('whatsapp_user', JSON.stringify(currentUser));
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('chat-container').style.display = 'flex';
      document.getElementById('user-avatar').innerText = currentUser.name.charAt(0);
      document.getElementById('sidebar-user-name').innerText = currentUser.name.split(' ')[0];
      loadConversations();
      startPolling();
    } else {
      showError('login-error', res.message);
    }
  }

  function logout() {
    clearInterval(messagesPollInterval);
    localStorage.removeItem('whatsapp_user');
    currentUser = null; selectedContact = null;
    document.getElementById('chat-container').style.display = 'none';
    document.getElementById('auth-container').style.display = 'flex';
    document.getElementById('login-email').value = '';
    document.getElementById('login-password').value = '';
    document.getElementById('login-error').innerText = '';
  }

  // ---------- CONVERSATIONS ----------
  async function loadConversations() {
    if (!currentUser) return;
    const res = await apiRequest('getConversations', { userEmail: currentUser.email });
    if (res.success) {
      conversations = res.conversations || [];
      renderConversations();
    }
  }

  function renderConversations() {
    const container = document.getElementById('conversations-list');
    if (!conversations.length) {
      container.innerHTML = '<div class="no-conversations">No chats yet. Start a new one!</div>';
      return;
    }
    let html = '';
    conversations.forEach(conv => {
      const activeClass = (selectedContact && selectedContact.email === conv.otherEmail) ? 'active' : '';
      html += `<div class="conversation-item ${activeClass}" onclick="selectConversation('${conv.otherEmail}', '${conv.otherName}')">
        <div class="conv-avatar">${conv.otherName.charAt(0)}</div>
        <div class="conv-details">
          <div class="conv-top"><span class="conv-name">${conv.otherName}</span><span class="conv-time">${formatTime(conv.timestamp)}</span></div>
          <div class="conv-last-msg">${conv.lastMessage.substring(0, 30)}${conv.lastMessage.length > 30 ? 'â€¦' : ''}</div>
        </div>
      </div>`;
    });
    container.innerHTML = html;
  }

  function selectConversation(contactEmail, contactName) {
    selectedContact = { email: contactEmail, name: contactName };
    document.getElementById('chat-header').style.display = 'flex';
    document.getElementById('chat-input-area').style.display = 'flex';
    document.getElementById('chat-avatar').innerText = contactName.charAt(0);
    document.getElementById('chat-contact-name').innerText = contactName;
    loadMessages();
    renderConversations();
  }

  // ---------- MESSAGES ----------
  async function loadMessages() {
    if (!currentUser || !selectedContact) return;
    const res = await apiRequest('getMessages', {
      userEmail: currentUser.email,
      contactEmail: selectedContact.email
    });
    if (res.success) {
      renderMessages(res.messages);
    }
  }

  function renderMessages(messages) {
    const area = document.getElementById('messages-area');
    if (!messages.length) {
      area.innerHTML = '<div style="text-align:center; color:#667781; margin-top:40px;">No messages yet. Say hello! ðŸ‘‹</div>';
      return;
    }
    let html = '';
    messages.forEach(msg => {
      const isSent = msg.sender === currentUser.email;
      const bubbleClass = isSent ? 'message-sent' : 'message-received';
      html += `<div class="message-bubble ${bubbleClass}">${msg.message}<div class="message-time">${formatTime(msg.timestamp)}</div></div>`;
    });
    area.innerHTML = html;
    area.scrollTop = area.scrollHeight;
  }

  async function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text || !selectedContact || !currentUser) return;
    const res = await apiRequest('sendMessage', {
      senderEmail: currentUser.email,
      receiverEmail: selectedContact.email,
      message: text
    });
    if (res.success) {
      input.value = '';
      loadMessages();
      loadConversations();
    }
  }

  // ---------- NEW CHAT MODAL ----------
  async function openNewChatModal() {
    const modal = document.getElementById('newChatModal');
    modal.classList.add('active');
    const res = await apiRequest('getUsers', { currentUserEmail: currentUser.email });
    if (res.success) {
      allUsers = res.users;
      renderUsersList(allUsers);
    }
  }

  function renderUsersList(users) {
    const container = document.getElementById('users-list');
    if (!users.length) {
      container.innerHTML = '<div style="padding:20px; text-align:center;">No other users found</div>';
      return;
    }
    let html = '';
    users.forEach(user => {
      html += `<div class="user-list-item" onclick="startNewChat('${user.email}', '${user.name}')">
        <div class="conv-avatar" style="width:40px; height:40px; margin-right:12px;">${user.name.charAt(0)}</div>
        <div><strong>${user.name}</strong><br><span style="color:#667781; font-size:14px;">${user.email}</span></div>
      </div>`;
    });
    container.innerHTML = html;
  }

  function filterUsers() {
    const query = document.getElementById('search-users').value.toLowerCase();
    const filtered = allUsers.filter(u => u.name.toLowerCase().includes(query) || u.email.toLowerCase().includes(query));
    renderUsersList(filtered);
  }

  function startNewChat(email, name) {
    closeNewChatModal();
    selectConversation(email, name);
  }
  function closeNewChatModal() {
    document.getElementById('newChatModal').classList.remove('active');
  }

  // ---------- POLLING ----------
  function startPolling() {
    if (messagesPollInterval) clearInterval(messagesPollInterval);
    messagesPollInterval = setInterval(() => {
      if (currentUser) {
        loadConversations();
        if (selectedContact) loadMessages();
      }
    }, 3000);
  }

  // ---------- INIT ----------
  window.onload = function() {
    document.getElementById('login-tab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('register-tab').classList.remove('active');
      document.getElementById('login-form').classList.add('active');
      document.getElementById('register-form').classList.remove('active');
      document.getElementById('login-error').innerText = '';
    });
    document.getElementById('register-tab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('login-tab').classList.remove('active');
      document.getElementById('register-form').classList.add('active');
      document.getElementById('login-form').classList.remove('active');
      document.getElementById('register-error').innerText = '';
    });

    const saved = localStorage.getItem('whatsapp_user');
    if (saved) {
      currentUser = JSON.parse(saved);
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('chat-container').style.display = 'flex';
      document.getElementById('user-avatar').innerText = currentUser.name.charAt(0);
      document.getElementById('sidebar-user-name').innerText = currentUser.name.split(' ')[0];
      loadConversations();
      startPolling();
    }
  };

  function filterConversations() {} // optional
</script>
</body>
</html>
