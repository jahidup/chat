<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes, viewport-fit=cover">
  <title>WhatsApp Premium ¬∑ Sheets</title>
  <!-- Font Awesome 6 (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Google Font: Inter (clean, modern) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <style>
    /* ---------- GLOBAL ‚Äì PREMIUM DARK THEME, FULLY RESPONSIVE ---------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #0b141a;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      line-height: 1.5;
    }

    #app {
      width: 100%;
      height: 100vh;
      background: #111b21;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      position: relative;
      overflow: hidden;
    }

    /* ----- AUTH SCREEN (unchanged, clean) ----- */
    #auth-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #0b141a;
      padding: 20px;
    }
    .auth-card {
      background: #1f2c34;
      width: 100%;
      max-width: 440px;
      border-radius: 24px;
      padding: 32px;
      color: white;
      box-shadow: 0 12px 28px rgba(0,0,0,0.5);
    }
    .auth-tabs {
      display: flex;
      margin-bottom: 28px;
      border-bottom: 1px solid #2a3942;
    }
    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      font-weight: 600;
      color: #8696a0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .auth-tab.active {
      color: #00a884;
      border-bottom: 3px solid #00a884;
    }
    .auth-form {
      display: none;
      flex-direction: column;
    }
    .auth-form.active { display: flex; }
    .auth-form h2 {
      margin-bottom: 24px;
      color: #00a884;
      font-size: 1.8rem;
      font-weight: 600;
    }
    .input-group {
      margin-bottom: 18px;
      position: relative;
    }
    .input-group i {
      position: absolute;
      left: 16px;
      top: 16px;
      color: #8696a0;
      font-size: 16px;
    }
    .input-group input {
      width: 100%;
      padding: 16px 16px 16px 48px;
      background: #2a3942;
      border: 1px solid #3a4a53;
      border-radius: 12px;
      font-size: 16px;
      color: white;
      outline: none;
      transition: border 0.2s;
    }
    .input-group input:focus {
      border-color: #00a884;
    }
    .input-group input::placeholder { color: #8696a0; }
    .btn {
      background: #00a884;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: background 0.2s, transform 0.1s;
    }
    .btn:hover { background: #0b7a6b; transform: scale(1.01); }
    .error-message { color: #ff6b6b; font-size: 14px; margin-top: 12px; text-align: center; }

    /* ----- MAIN APP ‚Äì RESPONSIVE GRID (mobile first, desktop upgrade) ----- */
    #main-container {
      display: none;
      flex-direction: column;
      height: 100%;
      width: 100%;
      background: #111b21;
      color: white;
    }

    /* Mobile layout: stacked */
    .app-header {
      background: #1f2c34;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #2a3942;
    }
    .app-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(145deg, #00a884, #0b7a6b);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .app-tabs {
      display: flex;
      background: #1f2c34;
      padding: 8px 16px;
      gap: 16px;
      border-bottom: 1px solid #2a3942;
    }
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      color: #8696a0;
      font-size: 15px;
      font-weight: 600;
      padding: 10px;
      border-radius: 30px;
      cursor: pointer;
      transition: 0.2s;
    }
    .tab-btn i { margin-right: 6px; }
    .tab-btn.active {
      background: #2a3942;
      color: white;
    }
    .tab-pane {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #111b21;
    }
    .tab-pane.active { display: block; }

    /* ----- CHATS LIST (Inbox) ----- */
    .conversation-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 16px;
      cursor: pointer;
      border-radius: 16px;
      transition: background 0.2s;
      margin-bottom: 4px;
    }
    .conversation-item:hover { background: #1f2c34; }
    .conv-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(145deg, #128C7E, #075E54);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 22px;
      text-transform: uppercase;
    }
    .conv-details { flex: 1; overflow: hidden; }
    .conv-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .conv-name {
      font-weight: 600;
      color: white;
      font-size: 16px;
    }
    .conv-time {
      font-size: 12px;
      color: #8696a0;
    }
    .conv-last-msg {
      color: #8696a0;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ----- CHAT WINDOW (right panel) ----- */
    .chat-window {
      display: none;
      flex-direction: column;
      height: 100%;
      background: #0b141a;
      border-left: 1px solid #2a3942;
    }
    .chat-header {
      background: #1f2c34;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid #2a3942;
    }
    .back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 22px;
      cursor: pointer;
      display: none; /* hidden on desktop, shown on mobile */
    }
    .chat-contact-info { flex: 1; }
    .chat-contact-name {
      font-weight: 700;
      font-size: 18px;
      color: white;
    }
    .refresh-btn {
      background: none;
      border: none;
      color: #8696a0;
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .refresh-btn:hover { background: #2a3942; }
    .messages-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: #0b141a;
      background-image: radial-gradient(rgba(42,57,66,0.3) 1px, transparent 1px);
      background-size: 8px 8px;
    }
    .message-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      margin-bottom: 10px;
      word-wrap: break-word;
      position: relative;
      font-size: 15px;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .message-sent {
      align-self: flex-end;
      background: #005c4b;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message-received {
      align-self: flex-start;
      background: #1f2c34;
      color: white;
      border-bottom-left-radius: 4px;
    }
    .message-time {
      font-size: 11px;
      color: #8696a0;
      margin-top: 6px;
      text-align: right;
    }
    .message-footer {
      display: flex;
      gap: 12px;
      margin-top: 6px;
      justify-content: flex-end;
    }
    .message-action {
      background: none;
      border: none;
      color: #8696a0;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 12px;
      transition: background 0.2s;
    }
    .message-action:hover { background: #2a3942; }
    .edited-badge { font-size: 11px; color: #8696a0; margin-left: 4px; }
    .reactions-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .reaction-item {
      background: #2a3942;
      border-radius: 20px;
      padding: 4px 10px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .reaction-item:hover { background: #3a4a53; }
    .chat-input-area {
      background: #1f2c34;
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .chat-input-area input {
      flex: 1;
      padding: 14px 18px;
      border: none;
      border-radius: 28px;
      background: #2a3942;
      color: white;
      font-size: 16px;
      outline: none;
    }
    .chat-input-area button {
      background: #00a884;
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .chat-input-area button:hover { background: #0b7a6b; }

    /* ----- CONTACTS TAB (with chat & remove buttons) ----- */
    .search-section {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    .search-section input {
      flex: 1;
      padding: 14px 18px;
      background: #2a3942;
      border: 1px solid #3a4a53;
      border-radius: 28px;
      color: white;
      font-size: 16px;
      outline: none;
    }
    .search-section button {
      background: #00a884;
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 28px;
      font-weight: 600;
      cursor: pointer;
    }
    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #1f2c34;
      border-radius: 18px;
      margin-bottom: 10px;
      transition: transform 0.2s;
    }
    .contact-item:hover { transform: translateY(-2px); background: #2a3942; }
    .contact-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .contact-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(145deg, #128C7E, #075E54);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 22px;
    }
    .contact-details { color: white; }
    .contact-name {
      font-weight: 700;
      font-size: 17px;
      margin-bottom: 4px;
    }
    .contact-email { font-size: 13px; color: #8696a0; }
    .contact-actions {
      display: flex;
      gap: 12px;
    }
    .chat-contact-btn, .remove-contact {
      background: none;
      border: none;
      color: #8696a0;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-contact-btn { color: #00a884; }
    .chat-contact-btn:hover { background: #075E54; color: white; }
    .remove-contact:hover { background: #ff6b6b; color: white; }

    /* ----- PROFILE TAB ----- */
    .profile-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 20px;
      background: #1f2c34;
      border-radius: 28px;
      margin: 16px;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(145deg, #00a884, #0b7a6b);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 54px;
      font-weight: 600;
      margin-bottom: 24px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.3);
    }
    .profile-field {
      width: 100%;
      padding: 18px;
      background: #2a3942;
      border-radius: 16px;
      margin-bottom: 16px;
      color: white;
    }
    .profile-field label {
      display: block;
      font-size: 13px;
      color: #8696a0;
      margin-bottom: 6px;
    }
    .profile-field div { font-size: 18px; font-weight: 500; }
    .logout-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 16px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
      transition: background 0.2s;
    }
    .logout-btn:hover { background: #ff5252; }

    /* ----- MODALS (premium) ----- */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 3000;
      backdrop-filter: blur(6px);
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #1f2c34;
      width: 90%;
      max-width: 440px;
      border-radius: 28px;
      padding: 28px;
      color: white;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-header h3 {
      color: #00a884;
      font-size: 22px;
    }
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
    }
    .user-result {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #2a3942;
      border-radius: 18px;
    }
    .reaction-picker {
      display: flex;
      justify-content: space-around;
      font-size: 36px;
      margin: 24px 0;
    }
    .reaction-picker span {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .reaction-picker span:hover { transform: scale(1.3); }

    /* ---------- DESKTOP LAYOUT (min-width: 900px) ‚Äì SIDE BY SIDE ---------- */
    @media (min-width: 900px) {
      #main-container {
        display: grid;
        grid-template-columns: minmax(360px, 30%) 1fr;
        grid-template-rows: auto auto 1fr;
      }
      .app-header { grid-column: 1 / -1; }
      .app-tabs { grid-column: 1; }
      .tab-pane {
        grid-column: 1;
        grid-row: 3;
        height: 100%;
        overflow-y: auto;
        padding-bottom: 0;
      }
      .chat-window {
        grid-column: 2;
        grid-row: 2 / 4;
        display: flex; /* always visible, but content depends on selectedContact */
        border-left: 1px solid #2a3942;
      }
      /* Hide back button on desktop */
      .back-btn { display: none; }
      /* Show chat window even if no contact selected ‚Äì show placeholder */
      .chat-window:has(.chat-contact-name:empty) .messages-area {
        display: flex;
        justify-content: center;
        align-items: center;
        color: #8696a0;
        font-size: 16px;
      }
    }

    /* Mobile adjustments: back button visible, chat window overlays */
    @media (max-width: 899px) {
      .back-btn { display: block; }
      /* When chat window is open on mobile, hide the left column */
      .chat-window.active-mobile {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 100;
        background: #0b141a;
        display: flex;
      }
      .chat-window:not(.active-mobile) { display: none; }
    }

    /* Placeholder for no chat on desktop */
    .no-chat-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #8696a0;
      font-size: 18px;
      gap: 16px;
    }
    .no-chat-placeholder i { font-size: 64px; color: #00a884; }

    /* Smooth scrolling */
    .messages-area, .tab-pane { scrollbar-width: thin; scrollbar-color: #2a3942 #111b21; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #111b21; }
    ::-webkit-scrollbar-thumb { background: #2a3942; border-radius: 8px; }
  </style>
</head>
<body>
<div id="app">
  <!-- ========== AUTH SCREEN ========== -->
  <div id="auth-container">
    <div class="auth-card">
      <div class="auth-tabs">
        <div id="login-tab" class="auth-tab active">Login</div>
        <div id="register-tab" class="auth-tab">Register</div>
      </div>
      <!-- Login Form -->
      <div id="login-form" class="auth-form active">
        <h2>Sign in</h2>
        <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="login-email" placeholder="Email" autocomplete="email"></div>
        <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="login-password" placeholder="Password"></div>
        <button class="btn" onclick="handleLogin()">Login</button>
        <div id="login-error" class="error-message"></div>
      </div>
      <!-- Register Form (with mobile) -->
      <div id="register-form" class="auth-form">
        <h2>Create account</h2>
        <div class="input-group"><i class="fas fa-user"></i><input type="text" id="reg-name" placeholder="Full name"></div>
        <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="reg-email" placeholder="Email"></div>
        <div class="input-group"><i class="fas fa-mobile-alt"></i><input type="tel" id="reg-mobile" placeholder="Mobile number"></div>
        <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="reg-password" placeholder="Password"></div>
        <button class="btn" onclick="handleRegister()">Register</button>
        <div id="register-error" class="error-message"></div>
      </div>
    </div>
  </div>

  <!-- ========== MAIN APP (after login) ========== -->
  <div id="main-container">
    <!-- Header with refresh & avatar -->
    <div class="app-header">
      <div class="app-header-left">
        <div class="avatar" id="header-avatar"></div>
        <span id="header-name" style="font-weight:600; font-size:18px;">WhatsApp</span>
      </div>
      <i class="fas fa-sync-alt" style="color:#8696a0; font-size:20px; cursor:pointer; padding:8px; border-radius:50%;" onclick="manualRefresh()"></i>
    </div>

    <!-- Tabs: Chats / Contacts / Profile -->
    <div class="app-tabs">
      <button id="tab-chats-btn" class="tab-btn active" onclick="switchTab('chats')"><i class="fas fa-comment"></i> Chats</button>
      <button id="tab-contacts-btn" class="tab-btn" onclick="switchTab('contacts')"><i class="fas fa-address-book"></i> Contacts</button>
      <button id="tab-profile-btn" class="tab-btn" onclick="switchTab('profile')"><i class="fas fa-user"></i> Profile</button>
    </div>

    <!-- CHATS TAB (left panel) -->
    <div id="chats-pane" class="tab-pane active">
      <div id="conversations-list"></div>
    </div>

    <!-- CONTACTS TAB (left panel) -->
    <div id="contacts-pane" class="tab-pane">
      <div class="search-section">
        <input type="text" id="contact-search-input" placeholder="Search by email, mobile or name">
        <button onclick="searchUser()">Search</button>
      </div>
      <div id="contacts-list"></div>
    </div>

    <!-- PROFILE TAB (left panel) -->
    <div id="profile-pane" class="tab-pane">
      <div class="profile-card">
        <div class="profile-avatar" id="profile-avatar"></div>
        <div class="profile-field"><label>Name</label><div id="profile-name"></div></div>
        <div class="profile-field"><label>Email</label><div id="profile-email"></div></div>
        <div class="profile-field"><label>Mobile</label><div id="profile-mobile"></div></div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- RIGHT PANEL ‚Äì CHAT WINDOW (visible on desktop always, on mobile only when opened) -->
    <div id="chat-window" class="chat-window">
      <div class="chat-header">
        <button class="back-btn" onclick="closeChatWindow()"><i class="fas fa-arrow-left"></i></button>
        <div class="chat-contact-info">
          <div class="chat-contact-name" id="chat-contact-name"></div>
        </div>
        <button class="refresh-btn" onclick="loadMessages()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div class="messages-area" id="messages-area">
        <!-- Default placeholder for desktop -->
        <div class="no-chat-placeholder">
          <i class="fas fa-comments"></i>
          <p>Select a chat to start messaging</p>
        </div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="message-input" placeholder="Type a message" autocomplete="off">
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- ========== MODAL: Search result (add contact) ========== -->
  <div id="searchResultModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>User Found</h3>
        <button class="close-btn" onclick="closeSearchModal()">&times;</button>
      </div>
      <div id="search-result-content"></div>
    </div>
  </div>

  <!-- ========== MODAL: Reaction picker ========== -->
  <div id="reactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Choose reaction</h3>
        <button class="close-btn" onclick="closeReactionModal()">&times;</button>
      </div>
      <div class="reaction-picker">
        <span onclick="addReaction(currentMessageId, 'üëç')">üëç</span>
        <span onclick="addReaction(currentMessageId, '‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span onclick="addReaction(currentMessageId, 'üòÇ')">üòÇ</span>
        <span onclick="addReaction(currentMessageId, 'üòÆ')">üòÆ</span>
        <span onclick="addReaction(currentMessageId, 'üò¢')">üò¢</span>
      </div>
      <button class="btn" style="margin-top:20px;" onclick="closeReactionModal()">Close</button>
    </div>
  </div>
</div>

<script>
  // ========== üî• YOUR GOOGLE APPS SCRIPT URL ‚Äì REPLACE THIS ==========
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdS7JFQOvp5H3oQK4Lvg0rS9_qWftn_-LAqg7qMcPQNLu-yDHQRVcGDfB_-vXlPsrSeg/exec';  // <-- PASTE YOUR DEPLOYED URL HERE

  // ---------- GLOBAL STATE ----------
  let currentUser = null;
  let selectedContact = null;
  let conversations = [];
  let contacts = [];
  let currentMessageId = null;
  let replyToMessage = null;

  // ---------- API REQUEST (NO CORS PREFLIGHT, PREMIUM ERROR HANDLING) ----------
  async function apiRequest(action, payload) {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action, ...payload }),
        headers: { 'Content-Type': 'text/plain' }
      });
      if (!res.ok) {
        let errorText = await res.text();
        throw new Error(`HTTP ${res.status}: ${errorText.substring(0,100)}`);
      }
      return await res.json();
    } catch (err) {
      console.error(err);
      alert(`‚ùå Network Error: ${err.message}\n\nüîß Fix:\n1. Verify the Apps Script URL is correct\n2. Redeploy as "Anyone"\n3. Run from local server (not file://)`);
      return { success: false, message: 'Network error ‚Äì check URL or deployment' };
    }
  }

  // ---------- AUTH ----------
  async function handleRegister() {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const mobile = document.getElementById('reg-mobile').value.trim();
    const password = document.getElementById('reg-password').value.trim();
    if (!name || !email || !mobile || !password) return showError('register-error', 'All fields required');
    const res = await apiRequest('register', { name, email, mobile, password });
    if (res.success) {
      showError('register-error', '‚úÖ Registration successful! Please login.');
      document.getElementById('login-tab').click();
      // Clear fields
      document.getElementById('reg-name').value = '';
      document.getElementById('reg-email').value = '';
      document.getElementById('reg-mobile').value = '';
      document.getElementById('reg-password').value = '';
    } else {
      showError('register-error', res.message);
    }
  }

  async function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    if (!email || !password) return showError('login-error', 'Enter credentials');
    const res = await apiRequest('login', { email, password });
    if (res.success) {
      currentUser = res.user;
      localStorage.setItem('whatsapp_user', JSON.stringify(currentUser));
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('main-container').style.display = 'grid';
      updateUIAfterLogin();
      loadConversations();
      loadContacts();
      // Reset chat window
      selectedContact = null;
      updateChatWindowForDesktop();
    } else {
      showError('login-error', res.message);
    }
  }

  function updateUIAfterLogin() {
    document.getElementById('header-avatar').innerText = currentUser.name.charAt(0);
    document.getElementById('header-name').innerText = currentUser.name.split(' ')[0];
    document.getElementById('profile-avatar').innerText = currentUser.name.charAt(0);
    document.getElementById('profile-name').innerText = currentUser.name;
    document.getElementById('profile-email').innerText = currentUser.email;
    document.getElementById('profile-mobile').innerText = currentUser.mobile;
  }

  function logout() {
    localStorage.removeItem('whatsapp_user');
    currentUser = null;
    selectedContact = null;
    document.getElementById('main-container').style.display = 'none';
    document.getElementById('auth-container').style.display = 'flex';
  }

  // ---------- RESPONSIVE LAYOUT HELPERS ----------
  function isMobile() {
    return window.innerWidth < 900;
  }

  // Update chat window visibility based on screen size and selected contact
  function updateChatWindowForDesktop() {
    const chatWindow = document.getElementById('chat-window');
    if (!isMobile()) {
      // Desktop: always show chat window, but with content or placeholder
      chatWindow.style.display = 'flex';
      if (selectedContact) {
        document.querySelector('.no-chat-placeholder')?.style.display = 'none';
        document.getElementById('chat-contact-name').innerText = selectedContact.name;
        document.getElementById('chat-input-area').style.display = 'flex';
        loadMessages();
      } else {
        // Show placeholder
        document.getElementById('chat-contact-name').innerText = '';
        document.getElementById('messages-area').innerHTML = `<div class="no-chat-placeholder"><i class="fas fa-comments"></i><p>Select a chat to start messaging</p></div>`;
        document.getElementById('chat-input-area').style.display = 'none';
      }
    } else {
      // Mobile: chat window is hidden by default, shown when selectedContact exists
      if (selectedContact) {
        chatWindow.classList.add('active-mobile');
        chatWindow.style.display = 'flex';
        document.getElementById('chat-contact-name').innerText = selectedContact.name;
        document.getElementById('chat-input-area').style.display = 'flex';
        loadMessages();
      } else {
        chatWindow.classList.remove('active-mobile');
        chatWindow.style.display = 'none';
      }
    }
  }

  // ---------- TAB SWITCHING ----------
  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
    if (tab === 'chats') {
      document.getElementById('tab-chats-btn').classList.add('active');
      document.getElementById('chats-pane').classList.add('active');
    } else if (tab === 'contacts') {
      document.getElementById('tab-contacts-btn').classList.add('active');
      document.getElementById('contacts-pane').classList.add('active');
      loadContacts(); // refresh contacts
    } else if (tab === 'profile') {
      document.getElementById('tab-profile-btn').classList.add('active');
      document.getElementById('profile-pane').classList.add('active');
    }
    // On mobile, close chat window if switching tabs
    if (isMobile() && selectedContact) {
      closeChatWindow();
    }
  }

  // ---------- CONVERSATIONS ----------
  async function loadConversations() {
    if (!currentUser) return;
    const res = await apiRequest('getConversations', { userEmail: currentUser.email });
    if (res.success) {
      conversations = res.conversations || [];
      renderConversations();
    }
  }

  function renderConversations() {
    const container = document.getElementById('conversations-list');
    if (!conversations.length) {
      container.innerHTML = '<div style="color:#8696a0; text-align:center; padding:40px;"><i class="fas fa-inbox" style="font-size:48px; margin-bottom:16px;"></i><p>No chats yet</p><p style="font-size:14px;">Start a new conversation from Contacts</p></div>';
      return;
    }
    let html = '';
    conversations.forEach(conv => {
      const activeClass = (selectedContact && selectedContact.email === conv.otherEmail) ? 'active' : '';
      html += `<div class="conversation-item ${activeClass}" onclick="openChat('${conv.otherEmail}', '${conv.otherName}')">
        <div class="conv-avatar">${conv.otherName.charAt(0)}</div>
        <div class="conv-details">
          <div class="conv-top"><span class="conv-name">${escapeHTML(conv.otherName)}</span><span class="conv-time">${formatTime(conv.timestamp)}</span></div>
          <div class="conv-last-msg">${escapeHTML(conv.lastMessage.substring(0, 35))}${conv.lastMessage.length > 35 ? '‚Ä¶' : ''}</div>
        </div>
      </div>`;
    });
    container.innerHTML = html;
  }

  // ---------- CHAT WINDOW ----------
  function openChat(contactEmail, contactName) {
    selectedContact = { email: contactEmail, name: contactName };
    // Highlight conversation
    renderConversations();
    // Update UI based on device
    if (isMobile()) {
      // On mobile: hide left column, show chat window
      document.querySelector('.app-tabs').style.display = 'none';
      document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
      document.getElementById('chat-window').classList.add('active-mobile');
      document.getElementById('chat-window').style.display = 'flex';
    }
    // Update chat header and load messages
    document.getElementById('chat-contact-name').innerText = contactName;
    document.getElementById('chat-input-area').style.display = 'flex';
    // Hide placeholder if any
    const placeholder = document.querySelector('.no-chat-placeholder');
    if (placeholder) placeholder.style.display = 'none';
    loadMessages();
  }

  function closeChatWindow() {
    selectedContact = null;
    if (isMobile()) {
      // On mobile: hide chat window, show tabs and active pane
      document.getElementById('chat-window').classList.remove('active-mobile');
      document.getElementById('chat-window').style.display = 'none';
      document.querySelector('.app-tabs').style.display = 'flex';
      // Show the currently active tab pane
      const activeTab = document.querySelector('.tab-btn.active').id.replace('tab-', '').replace('-btn', '');
      document.getElementById(`${activeTab}-pane`).style.display = 'block';
    } else {
      // Desktop: clear selected contact and show placeholder
      document.getElementById('chat-contact-name').innerText = '';
      document.getElementById('messages-area').innerHTML = `<div class="no-chat-placeholder"><i class="fas fa-comments"></i><p>Select a chat to start messaging</p></div>`;
      document.getElementById('chat-input-area').style.display = 'none';
    }
    replyToMessage = null;
    document.getElementById('message-input').placeholder = 'Type a message';
  }

  async function loadMessages() {
    if (!currentUser || !selectedContact) return;
    const res = await apiRequest('getMessages', {
      userEmail: currentUser.email,
      contactEmail: selectedContact.email
    });
    if (res.success) {
      renderMessages(res.messages);
    }
  }

  function renderMessages(messages) {
    const area = document.getElementById('messages-area');
    if (!messages.length) {
      area.innerHTML = '<div style="text-align:center; color:#8696a0; margin-top:60px;"><i class="fas fa-hand-peace" style="font-size:48px; margin-bottom:16px;"></i><p>Say hello! üëã</p></div>';
      return;
    }
    let html = '';
    messages.forEach(msg => {
      const isSent = msg.sender === currentUser.email;
      const bubbleClass = isSent ? 'message-sent' : 'message-received';
      let messageText = msg.deleted ? '<i>This message was deleted</i>' : escapeHTML(msg.message);
      if (msg.edited) messageText += ' <span class="edited-badge">(edited)</span>';
      
      let replyHtml = '';
      if (msg.replyToId) {
        replyHtml = `<div style="font-size:12px; color:#8696a0; border-left:2px solid #00a884; padding-left:8px; margin-bottom:6px;">‚Ü™Ô∏è Reply</div>`;
      }
      
      let reactionsHtml = '';
      if (msg.reactions && msg.reactions.length) {
        const counts = {};
        msg.reactions.forEach(r => counts[r.reaction] = (counts[r.reaction] || 0) + 1);
        reactionsHtml = '<div class="reactions-row">' + 
          Object.entries(counts).map(([emoji, count]) =>
            `<span class="reaction-item" onclick="toggleReaction('${msg.id}', '${emoji}')">${emoji} ${count}</span>`
          ).join('') + 
        '</div>';
      }

      html += `<div class="message-bubble ${bubbleClass}" id="msg-${msg.id}">
        ${replyHtml}
        <div>${messageText}</div>
        <div class="message-time">${formatTime(msg.timestamp)}</div>
        <div class="message-footer">
          ${!isSent ? `<button class="message-action" onclick="replyTo('${msg.id}', '${escapeHTML(msg.message)}')"><i class="fas fa-reply"></i> Reply</button>` : ''}
          ${isSent && !msg.deleted ? `<button class="message-action" onclick="editMessage('${msg.id}')"><i class="fas fa-edit"></i> Edit</button>` : ''}
          ${isSent && !msg.deleted ? `<button class="message-action" onclick="deleteMessage('${msg.id}')"><i class="fas fa-trash"></i> Delete</button>` : ''}
          <button class="message-action" onclick="openReactionModal('${msg.id}')"><i class="fas fa-smile"></i> React</button>
        </div>
        ${reactionsHtml}
      </div>`;
    });
    area.innerHTML = html;
    area.scrollTop = area.scrollHeight;
  }

  async function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text || !selectedContact) return;
    const res = await apiRequest('sendMessage', {
      senderEmail: currentUser.email,
      receiverEmail: selectedContact.email,
      message: text,
      replyToId: replyToMessage ? replyToMessage.id : null
    });
    if (res.success) {
      input.value = '';
      replyToMessage = null;
      document.getElementById('message-input').placeholder = 'Type a message';
      loadMessages();
      loadConversations();
    }
  }

  // ---------- MESSAGE ACTIONS ----------
  function replyTo(msgId, msgText) {
    replyToMessage = { id: msgId, text: msgText };
    document.getElementById('message-input').placeholder = `‚Ü™Ô∏è Reply to: ${msgText.substring(0,30)}...`;
    document.getElementById('message-input').focus();
  }

  async function editMessage(msgId) {
    const newText = prompt('Edit your message:');
    if (newText && newText.trim()) {
      await apiRequest('editMessage', { messageId: msgId, newText: newText.trim() });
      loadMessages();
    }
  }

  async function deleteMessage(msgId) {
    if (confirm('Delete this message?')) {
      await apiRequest('deleteMessage', { messageId: msgId });
      loadMessages();
      loadConversations();
    }
  }

  // Reactions
  function openReactionModal(msgId) {
    currentMessageId = msgId;
    document.getElementById('reactionModal').classList.add('active');
  }
  function closeReactionModal() {
    document.getElementById('reactionModal').classList.remove('active');
  }
  async function addReaction(msgId, emoji) {
    await apiRequest('addReaction', { messageId: msgId, userEmail: currentUser.email, reaction: emoji });
    closeReactionModal();
    loadMessages();
  }
  async function toggleReaction(msgId, emoji) {
    await apiRequest('removeReaction', { messageId: msgId, userEmail: currentUser.email, reaction: emoji });
    loadMessages();
  }

  // ---------- CONTACTS ----------
  async function loadContacts() {
    if (!currentUser) return;
    const res = await apiRequest('getContacts', { userEmail: currentUser.email });
    if (res.success) {
      contacts = res.contacts;
      renderContacts();
    }
  }

  function renderContacts() {
    const container = document.getElementById('contacts-list');
    if (!contacts.length) {
      container.innerHTML = '<div style="color:#8696a0; padding:40px; text-align:center;"><i class="fas fa-address-book" style="font-size:48px; margin-bottom:16px;"></i><p>No contacts yet</p><p style="font-size:14px;">Search and add people to start chatting</p></div>';
      return;
    }
    let html = '';
    contacts.forEach(contact => {
      html += `<div class="contact-item">
        <div class="contact-info">
          <div class="contact-avatar">${contact.name.charAt(0)}</div>
          <div class="contact-details">
            <div class="contact-name">${escapeHTML(contact.name)}</div>
            <div class="contact-email">${escapeHTML(contact.email)}</div>
          </div>
        </div>
        <div class="contact-actions">
          <button class="chat-contact-btn" onclick="openChat('${contact.email}', '${contact.name}')" title="Start chat"><i class="fas fa-comment"></i></button>
          <button class="remove-contact" onclick="removeContact('${contact.email}')" title="Remove contact"><i class="fas fa-user-minus"></i></button>
        </div>
      </div>`;
    });
    container.innerHTML = html;
  }

  async function searchUser() {
    const query = document.getElementById('contact-search-input').value.trim();
    if (!query) return;
    const res = await apiRequest('searchUser', { query, currentUserEmail: currentUser.email });
    const contentDiv = document.getElementById('search-result-content');
    if (res.success) {
      const user = res.user;
      const isContact = contacts.some(c => c.email === user.email);
      contentDiv.innerHTML = `<div class="user-result">
        <div>
          <strong style="font-size:18px;">${escapeHTML(user.name)}</strong><br>
          <span style="color:#8696a0;">${escapeHTML(user.email)} ‚Ä¢ ${user.mobile}</span>
        </div>
        ${!isContact ? 
          `<button class="btn" style="padding:10px 20px;" onclick="addContact('${user.email}')">Add Contact</button>` : 
          '<span style="color:#00a884; font-weight:600;">‚úì In contacts</span>'}
      </div>`;
    } else {
      contentDiv.innerHTML = '<p style="color:#ff6b6b; text-align:center; padding:20px;">‚ùå User not found</p>';
    }
    document.getElementById('searchResultModal').classList.add('active');
  }

  async function addContact(contactEmail) {
    const res = await apiRequest('addContact', { userEmail: currentUser.email, contactEmail });
    if (res.success) {
      closeSearchModal();
      loadContacts();
    } else {
      alert(res.message);
    }
  }

  async function removeContact(contactEmail) {
    if (confirm('Remove this contact?')) {
      await apiRequest('removeContact', { userEmail: currentUser.email, contactEmail });
      loadContacts();
      // If currently chatting with this contact, close chat
      if (selectedContact && selectedContact.email === contactEmail) {
        closeChatWindow();
      }
    }
  }

  function closeSearchModal() {
    document.getElementById('searchResultModal').classList.remove('active');
    document.getElementById('contact-search-input').value = '';
  }

  // ---------- REFRESH & AUTO REFRESH ----------
  function manualRefresh() {
    if (selectedContact) loadMessages();
    loadConversations();
    loadContacts();
  }
  // Auto refresh every 5 seconds
  setInterval(() => {
    if (currentUser) {
      loadConversations();
      if (selectedContact) loadMessages();
      loadContacts();
    }
  }, 5000);

  // ---------- UTILS ----------
  function formatTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    if (diff < 86400000) {
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } else {
      return d.toLocaleDateString([], { day: 'numeric', month: 'short' });
    }
  }
  function escapeHTML(str) {
    return String(str).replace(/[&<>"]/g, function(c) {
      if(c === '&') return '&amp;';
      if(c === '<') return '&lt;';
      if(c === '>') return '&gt;';
      if(c === '"') return '&quot;';
      return c;
    });
  }
  function showError(id, msg) {
    document.getElementById(id).innerText = msg;
  }

  // ---------- INIT & EVENT LISTENERS ----------
  window.onload = function() {
    // Auth tab switching
    document.getElementById('login-tab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('register-tab').classList.remove('active');
      document.getElementById('login-form').classList.add('active');
      document.getElementById('register-form').classList.remove('active');
      document.getElementById('login-error').innerText = '';
      document.getElementById('register-error').innerText = '';
    });
    document.getElementById('register-tab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('login-tab').classList.remove('active');
      document.getElementById('register-form').classList.add('active');
      document.getElementById('login-form').classList.remove('active');
      document.getElementById('login-error').innerText = '';
      document.getElementById('register-error').innerText = '';
    });

    // Restore session
    const saved = localStorage.getItem('whatsapp_user');
    if (saved) {
      currentUser = JSON.parse(saved);
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('main-container').style.display = 'grid';
      updateUIAfterLogin();
      loadConversations();
      loadContacts();
      updateChatWindowForDesktop();
    }

    // Listen for window resize to adapt layout
    window.addEventListener('resize', function() {
      if (currentUser) {
        updateChatWindowForDesktop();
        // On mobile, if chat window is open, keep left column hidden
        if (isMobile() && selectedContact) {
          document.querySelector('.app-tabs').style.display = 'none';
          document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
          document.getElementById('chat-window').classList.add('active-mobile');
        } else if (!isMobile() && selectedContact) {
          // Desktop mode: ensure left column is visible
          document.querySelector('.app-tabs').style.display = 'flex';
          document.querySelectorAll('.tab-pane').forEach(p => p.style.display = ''); // restore based on active
          // active pane will be shown by its class
        }
      }
    });
  };
</script>
</body>
</html>
